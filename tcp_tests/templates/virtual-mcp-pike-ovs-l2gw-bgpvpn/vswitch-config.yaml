
{%- macro MACRO_CONFIGURE_VSWITCH(NODE_NAME, IP) %}
{#####################################################}

- description: 'Install openvswitch-vtep package and configure it'
  cmd: |
    ip addr add {{ IP }} dev ens4
    ifconfig ens4 up

    service openvswitch-switch stop
    apt-get install openvswitch-vtep bridge-utils

    ovsdb-tool create /etc/openvswitch/vtep.db /usr/share/openvswitch/vtep.ovsschema
    ovsdb-tool create /etc/openvswitch/vswitch.db /usr/share/openvswitch/vswitch.ovsschema
    ovsdb-server --pidfile --detach --log-file --remote ptcp:6632:{{ IP }} --remote punix:/var/run/openvswitch/db.sock --remote=db:hardware_vtep,Global,managers /etc/openvswitch/vswitch.db /etc/openvswitch/vtep.db
    ovs-vswitchd --log-file --detach --pidfile unix:/var/run/openvswitch/db.sock
    ovs-vsctl add-br v-switch
    vtep-ctl add-ps v-switch
    vtep-ctl set Physical_Switch v-switch tunnel_ips={{ IP }}
    ovs-vsctl add-port v-switch port0 -- set interface port0 type=internal
    vtep-ctl add-port v-switch port0
    /usr/share/openvswitch/scripts/ovs-vtep --log-file=/var/log/openvswitch/ovs-vtep.log --pidfile=/var/run/openvswitch/ovs-vtep.pid --detach v-switch
  node_name: {{ NODE_NAME }}
  retry: {count: 1, delay: 5}
  skip_fail: false

{%- endmacro %}