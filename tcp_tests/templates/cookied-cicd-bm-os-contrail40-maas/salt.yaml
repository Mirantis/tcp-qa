{% from 'cookied-cicd-bm-os-contrail40-maas/underlay.yaml' import HOSTNAME_CFG01 with context %}
{% from 'cookied-cicd-bm-os-contrail40-maas/underlay.yaml' import LAB_CONFIG_NAME with context %}
{% from 'cookied-cicd-bm-os-contrail40-maas/underlay.yaml' import DOMAIN_NAME with context %}

# Other salt model repository parameters see in shared-salt.yaml

{% import 'shared-salt.yaml' as SHARED with context %}

{{ SHARED.MACRO_INSTALL_SALT_MINIONS() }}

{{SHARED.MACRO_CHECK_SALT_VERSION_SERVICES_ON_CFG()}}

{{SHARED.MACRO_CHECK_SALT_VERSION_ON_NODES()}}

- description: Run comissioning of BM nodes
  cmd: |
    salt-call maas.process_machines
  node_name: {{ HOSTNAME_CFG01 }}
  retry: {count: 1, delay: 5}
  skip_fail: false

- description: Wait for machines ready
  cmd: |
    timeout 120 salt-call state.sls maas.machines.wait_for_ready;
    salt-call maas.machines_status;
  node_name: {{ HOSTNAME_CFG01 }}
  retry: {count: 7, delay: 5}
  skip_fail: false

- description: Enforce the interfaces configuration defined in the model for servers
  cmd: |
    salt-call state.sls maas.machines.assign_ip;
  node_name: {{ HOSTNAME_CFG01 }}
  retry: {count: 1, delay: 5}
  skip_fail: false

- description: provision the automatically commissioned physical nodes through MAAS
  cmd: |
    salt-call maas.deploy_machines;
  node_name: {{ HOSTNAME_CFG01 }}
  retry: {count: 3, delay: 5}
  skip_fail: false

- description: Wait for machines deployed
  cmd: |
    timeout 300 salt-call state.sls maas.machines.wait_for_deployed;
    salt-call maas.machines_status;
  node_name: {{ HOSTNAME_CFG01 }}
  retry: {count: 6, delay: 5}
  skip_fail: false
