{# 'infra_config_classes' list object is dynamically generated from 'roles' to add on the cfg node #}
{%- set infra_config_classes = [] %}
parameters:
  _param:
    _esc: $
  reclass:
    storage:
      node:
      {%- for inventory_node_name, node in nodes.items()|sort %}
        {{ node['reclass_storage_name'] }}:
        {# 'params' dict object is dynamically generated from 'roles' to add on the node #}
        {%- set params = {} %}
          classes:
          {#- Default role linux_network_interface is added to each node #}
          {%- for role in node.get('roles', []) + ['linux_network_interface'] %}
            {%- include ("{# roles #}/" + role) %}
          {%- endfor %}

        {%- if params %}
          params:
          {%- for param_name, param in params.items() %}
            {{ param_name }}: {{ param }}
          {%- endfor %}
        {%- endif %}

      {%- endfor %}

classes:
{%- for infra_config_class in infra_config_classes %}
- {{ infra_config_class }}
{%- endfor %}
